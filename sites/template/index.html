<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Product Catalog</title>
    <link rel="stylesheet" href="../../sites/css_configs/ecommerce.css">
    <style>
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        
        .notification {
            background-color: #fff;
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            animation: fadeIn 0.5s;
        }
        
        .notification.info {
            background-color: #f0f0f0;
            border-color: #ccc;
        }
        
        .notification.success {
            background-color: #dff0d8;
            border-color: #d6e9c6;
        }
        
        .notification.error {
            background-color: #f2dede;
            border-color: #ebccd1;
        }
        
        .notification.fade-out {
            animation: fadeOut 0.5s;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes fadeOut {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(20px);
            }
        }
    </style>
</head>

<body>
    <nav id="site-nav" name="main-navigation">
        <a href="index.html" id="nav-products-link" name="products-link">Products</a>
        <a href="cart.html" id="nav-cart-link" name="cart-link">Cart</a>
    </nav>

    <section id="search-section" class="search-container">
        <div id="filters-container" class="filters-wrapper">
            <div id="search-input-container" name="search-input-wrapper">
                <label for="search-input" id="search-input-label" name="search-label">Search Products:</label>
                <input type="text" id="search-input" name="product-search-input" placeholder="Search products...">
            </div>

            <div id="category-filter-container" name="category-filter-wrapper">
                <label for="category-filter" id="category-filter-label" name="category-label">Filter by
                    Category:</label>
                <select id="category-filter" name="product-category-filter">
                </select>
            </div>

            <div id="price-filter-container" name="price-filter-wrapper" class="price-filters">
                <div id="price-min-wrapper" name="min-price-wrapper">
                    <label for="price-min" id="price-min-label" name="min-price-label">Min Price:</label>
                    <input type="number" id="price-min" name="product-price-min" min="0" placeholder="Min">
                </div>
                <div id="price-max-wrapper" name="max-price-wrapper">
                    <label for="price-max" id="price-max-label" name="max-price-label">Max Price:</label>
                    <input type="number" id="price-max" name="product-price-max" min="0" placeholder="Max">
                </div>
            </div>
        </div>
    </section>

    <section id="products-section" class="products-container">
        <div id="pagination-top" class="pagination-controls top">
            <button id="prev-page-top" class="pagination-btn prev">Previous</button>
            <div class="page-numbers">
                <button class="pagination-btn page-number" data-page="1">1</button>
                <button class="pagination-btn page-number" data-page="2">2</button>
                <button class="pagination-btn page-number" data-page="3">3</button>
                <button class="pagination-btn page-number" data-page="4">4</button>
            </div>
            <button id="next-page-top" class="pagination-btn next">Next</button>
        </div>

        <div id="product-grid" class="products-grid">
            <!-- Products will be dynamically loaded here -->
        </div>

        <div id="pagination-bottom" class="pagination-controls bottom">
            <button id="prev-page-bottom" class="pagination-btn prev">Previous</button>
            <div class="page-numbers">
                <button class="pagination-btn page-number" data-page="1">1</button>
                <button class="pagination-btn page-number" data-page="2">2</button>
                <button class="pagination-btn page-number" data-page="3">3</button>
                <button class="pagination-btn page-number" data-page="4">4</button>
            </div>
            <button id="next-page-bottom" class="pagination-btn next">Next</button>
        </div>
    </section>

    <section id="cart-section" name="cart-content-section">
        <!-- Cart content will go here -->
    </section>

    <div id="notification-container" style="
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
    "></div>

    <script src="../../sites/shared/notifications.js"></script>
    <script>
        let currentPage = 1;
        let totalPages = 1;

        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        async function fetchCategories() {
            try {
                const response = await fetch('/api/categories');
                const data = await response.json();
                
                const categoryFilter = document.getElementById('category-filter');
                categoryFilter.innerHTML = '<option value="">All Categories</option>';
                
                data.categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    option.id = `category-option-${category.toLowerCase().replace(/\s+/g, '-')}`;
                    option.name = 'category-option';
                    categoryFilter.appendChild(option);
                });
            } catch (error) {
                console.error('Failed to fetch categories:', error);
            }
        }

        async function fetchProducts() {
            try {
                const searchTerm = document.getElementById('search-input').value;
                const categoryFilter = document.getElementById('category-filter').value;
                const minPrice = document.getElementById('price-min').value || 0;
                const maxPrice = document.getElementById('price-max').value || Infinity;

                const params = new URLSearchParams({
                    page: currentPage,
                    per_page: 12,
                    search: searchTerm,
                    category: categoryFilter,
                    min_price: minPrice,
                    max_price: maxPrice
                });

                const response = await fetch(`/api/products?${params.toString()}`);
                const data = await response.json();
                
                const productsContainer = document.getElementById('product-grid');
                productsContainer.innerHTML = data.products.map((product) => `
                    <div class="product-card" id="product-card-${product.id}">
                        <div class="product-image-container">
                            <img src="${product.image_url || 'placeholder.jpg'}" alt="${escapeHtml(product.name)}" class="product-image">
                        </div>
                        <div class="product-info">
                            <div class="product-title-container">
                                <h3 class="product-title">${escapeHtml(product.name)}</h3>
                            </div>
                            <div class="product-category-container">
                                <p class="product-category">${escapeHtml(product.category)}</p>
                            </div>
                            <div class="product-price-container">
                                <p class="product-price">$${product.price.toFixed(2)}</p>
                            </div>
                            <div class="product-rating-container">
                                <div class="product-rating">
                                    ${'★'.repeat(Math.round(product.avg_rating)) + '☆'.repeat(5 - Math.round(product.avg_rating))}
                                    <span class="rating-text">(${product.avg_rating.toFixed(1)})</span>
                                </div>
                            </div>
                            <div class="view-product-btn-container">
                                <button 
                                    class="view-product-btn"
                                    onclick="viewProductDetail(${product.id})"
                                >View Details</button>
                            </div>
                        </div>
                    </div>
                `).join('');

                totalPages = data.total_pages;
                updatePaginationControls();
            } catch (error) {
                console.error('Failed to fetch products:', error);
                document.getElementById('product-grid').innerHTML = `<p id="fetch-error-message" name="products-fetch-error">Error loading products: ${error.message}</p>`;
            }
        }

        function updatePaginationControls() {
            const basePageStart = Math.max(1, Math.min(
                currentPage - 1, 
                totalPages - 3
            ));

            const pageNumberBtns = document.querySelectorAll('.page-number');
            pageNumberBtns.forEach((btn, index) => {
                const pageNum = basePageStart + index;
                btn.textContent = pageNum;
                btn.dataset.page = pageNum;
                btn.classList.toggle('active', pageNum === currentPage);
                btn.style.display = pageNum <= totalPages ? 'block' : 'none';
            });

            const prevButtons = document.querySelectorAll('.pagination-btn.prev');
            const nextButtons = document.querySelectorAll('.pagination-btn.next');
            
            prevButtons.forEach(btn => {
                btn.disabled = currentPage === 1;
            });
            
            nextButtons.forEach(btn => {
                btn.disabled = currentPage === totalPages;
            });
        }

        function viewProductDetail(productId) {
            const urlParams = new URLSearchParams(window.location.search);
            const cssParam = urlParams.get('css');
            const themeParam = urlParams.get('theme');

            let productDetailUrl = `product-detail.html?id=${productId}`;
            if (themeParam) {
                productDetailUrl += `&theme=${themeParam}`;
            } else if (cssParam) {
                productDetailUrl += `&css=${cssParam}`;
            }

            window.location.href = productDetailUrl;
        }

        async function addToCart(productId) {
            try {
                const response = await fetch('/api/cart/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        productId: productId,
                        quantity: 1
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showNotification('Product added to cart', 'success');
                    
                    // Update cart badge
                    const cartBadge = document.querySelector('.cart-badge');
                    if (cartBadge) {
                        cartBadge.textContent = result.cart.length;
                        cartBadge.style.display = result.cart.length > 0 ? 'inline-block' : 'none';
                    }
                } else {
                    showNotification(result.error || 'Failed to add product to cart', 'error');
                }
            } catch (error) {
                console.error('Failed to add to cart:', error);
                showNotification('Failed to add product to cart', 'error');
            }
        }

        document.getElementById('search-input').addEventListener('input', () => {
            currentPage = 1;
            fetchProducts();
        });

        document.getElementById('category-filter').addEventListener('change', () => {
            currentPage = 1;
            fetchProducts();
        });

        document.getElementById('price-min').addEventListener('input', () => {
            currentPage = 1;
            fetchProducts();
        });

        document.getElementById('price-max').addEventListener('input', () => {
            currentPage = 1;
            fetchProducts();
        });

        document.querySelectorAll('.pagination-btn.page-number').forEach(btn => {
            btn.addEventListener('click', () => {
                currentPage = parseInt(btn.dataset.page);
                fetchProducts();
            });
        });

        document.querySelectorAll('.pagination-btn.prev').forEach(btn => {
            btn.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    fetchProducts();
                }
            });
        });

        document.querySelectorAll('.pagination-btn.next').forEach(btn => {
            btn.addEventListener('click', () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    fetchProducts();
                }
            });
        });

        document.addEventListener('DOMContentLoaded', () => {
            fetchCategories();
            fetchProducts();
        });
    </script>
</body>

</html>